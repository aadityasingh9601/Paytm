name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  # Detect what changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      user-app: ${{ steps.filter.outputs.user-app }}
      mock-bank: ${{ steps.filter.outputs.mock-bank }}
      bank-webhook: ${{ steps.filter.outputs.bank-webhook }}
      packages: ${{ steps.filter.outputs.packages }}
    steps:
      - uses: actions/checkout@v3

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            user-app:
              - 'apps/user-app/**'
              - 'package.json'
              - 'turbo.json'
            mock-bank:
              - 'apps/mock-bank/**'
              - 'package.json'
              - 'turbo.json'
            bank-webhook:
              - 'apps/bank-webhook/**'
              - 'package.json'
              - 'turbo.json'
            packages:
              - 'packages/**'

  # Build user-app if changed OR packages changed
  build-user-app:
    needs: changes
    if: needs.changes.outputs.user-app == 'true' || needs.changes.outputs.packages == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push user-app docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/DockerFile.userApp
          push: true
          tags: aaditya999/wallet-userapp:latest # Replace with your Docker Hub username and repository

      - name: Verify Pushed Image
        run: docker pull aaditya999/wallet-userapp:latest # Replace with your Docker Hub username and repository

  # Build mock-bank if changed OR packages changed
  build-mock-bank:
    needs: changes
    if: needs.changes.outputs.mock-bank == 'true' || needs.changes.outputs.packages == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push mock-bank docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/DockerFile.mockBank
          push: true
          tags: aaditya999/wallet-mockbank:latest # Replace with your Docker Hub username and repository

      - name: Verify Pushed Image
        run: docker pull aaditya999/wallet-mockbank:latest # Replace with your Docker Hub username and repository

  # Build webhook if changed OR packages changed
  build-webhook:
    needs: changes
    if: needs.changes.outputs.bank-webhook == 'true' || needs.changes.outputs.packages == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push bank-webhook docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/DockerFile.bankWebhook
          push: true
          tags: aaditya999/wallet-bankwebhook:latest # Replace with your Docker Hub username and repository

      - name: Verify Pushed Image
        run: docker pull aaditya999/wallet-bankwebhook:latest # Replace with your Docker Hub username and repository

  # Deploy to EC2 (only what changed)
  deploy:
    needs: [changes, build-user-app, build-mock-bank, build-webhook]
    if: always() && (needs.build-user-app.result == 'success' || needs.build-mock-bank.result == 'success' || needs.build-webhook.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }} # Public IP of EC2 instance.
          username: ${{ secrets.SSH_USERNAME }} # Username inside the EC2 instance, usually it's "ubuntu".
          key: ${{ secrets.SSH_KEY }} #SSH key for your EC2 instance.
          script: |
            cd /home/ubuntu/paytm-deploy
            sudo docker-compose pull  
            sudo docker-compose up -d --no-deps

        # Restart only updated services
